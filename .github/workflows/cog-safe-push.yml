name: Cog Safe Push

on:
  workflow_dispatch:
    inputs:
      model:
        description: 'The name of the model to push, in the format owner/model-name'
        type: string
        required: true
        default: 'selmakcby/video-model'

jobs:
  cog-safe-push:
    # Tip: Create custom runners in your GitHub organization for faster builds
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    - name: Install Cog
      run: |
        sudo curl -o /usr/local/bin/cog -L https://github.com/replicate/cog/releases/latest/download/cog_`uname -s`_`uname -m`
        sudo chmod +x /usr/local/bin/cog

    - name: cog login
      run: |
        echo ${{ secrets.COG_TOKEN }} | cog login --token-stdin

    - name: Install cog-safe-push
      run: |
        pip install git+https://github.com/replicate/cog-safe-push.git
        cog-safe-push --help || true

    - name: Push selected models
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
      run: |
        MODEL_NAME="${{ inputs.model }}"
        if [ -z "$MODEL_NAME" ]; then
          echo "Error: Model name is required"
          exit 1
        fi
        echo "Model name: $MODEL_NAME"
        echo "Checking for config file..."
        ls -la cog-safe-push.yaml 2>/dev/null || echo "No cog-safe-push.yaml found (this is OK)"
        echo "Running cog-safe-push..."
        cog-safe-push "$MODEL_NAME" --verbose || cog-safe-push "$MODEL_NAME"

